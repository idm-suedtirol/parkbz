{{extend 'layout.html'}}
<section class="span12">
	<div class="btn-group nav pull-right">
		<button id="force_all" class="btn" title="Reload all"><i class="icon-refresh"></i></button>
		<button data-toggle="dropdown" class="btn dropdown-toggle"><span class="caret"></span></button>
		<ul class="dropdown-menu">
			<li class="disabled"><a id="switch_on"  href="#">{{=T('Turn live update on')}}</a></li>
			<li><a id="switch_off" href="#">{{=T('Turn live update off')}}</a></li>
		</ul>
	</div>
	<table id='parks' class="table table-striped table-bordered table-condensed">
	<thead><tr class=info><th>{{=T('Parking')}}</th><th>{{=T("Free slots")}} <a class="hidden-phone pull-right" title="{{=T('Data are updated every 5 minutes')}}"><i class="icon-info-sign"></i></a></th></tr></thead>	
	<tbody>
	{{for park in parks:}}
		<tr id="park_{{=park['park_id']}}">
		<td><h4><a href="{{=URL('default', T('parking', lazy=False), args=[park['park_id'], XML(park['name'])])}}">{{=park['name']}}</a></h4>
<address><strong><abbr title="{{=T('Address')}}">{{=T('Address')}}:</abbr></strong> {{=park['address']}} - <strong><abbr title="{{=T('Phone')}}">{{=T('Phone')}}:</abbr></strong> {{=(park['phone'] or '--')}}</address>
		</td>
		<td title="{{=T('Click to update')}}" class="refresh accordion-toggle">
			<span id="{{='spinner_%s' % park['park_id']}}" class="spinner pull-right">
				<img alt='' src="/parkbz/static/img/spinner.gif">
			</span>
			<div class="progress">{{#include 'default/park_bar.html'}}</div>		
		</td>
	{{pass}}	
	</tbody></table>
</section>
<script>
var ajax_active = true;
$('span.spinner').hide();
$('#parks').on('click', '.refresh', function() {
	id = $(this).parents('tr').attr('id').split('_')[1];
	get_freeSlots(id);
});
$(document).on('click', '#force_all', function() {
	$( "tr[id^='park_']" ).each(function() {
		park_id = $(this).attr('id').split('_')[1];	
		get_freeSlots(park_id, true);	
	});
});
$(document).on('click', '#switch_off', function() {	
	ajax_active = false;
	$('#switch_on').parent().toggleClass('disabled');
	$('#switch_off').parent().toggleClass('disabled');
});
$(document).on('click', '#switch_on', function() {
	ajax_active = true;
	$('#switch_on').parent().toggleClass('disabled');
	$('#switch_off').parent().toggleClass('disabled');
});

{{for park in parks:}}
	//setTimeout( function() {get_freeSlots({{=park['park_id']}})}, (20+Math.floor((Math.random()*10)+1))*1000 );
	setTimeout(	function() {get_freeSlots({{=park['park_id']}})}, (Math.floor((Math.random()*10)+1))*250 );
{{pass}} 
function parseAnswer(park, json) {
	html = json.plain_html;
	/*freeslots = json.freeslots;
	if (parseInt($('#freeslots_' + park).text()) !== parseInt(freeslots)) {
		progress = $('#park_' + park + ' .progress').html(html);	
	}*/
	progress = $('#park_' + park + ' .progress');
	if (html) {
		progress.fadeIn(2000, function() {
			progress.html(html);
		});
		setTimeout( function() {get_freeSlots(park)}, 5*60*1000);
	} else {
		setTimeout( function() {get_freeSlots(park)}, 20*1000);
	}
	$(progress).fadeTo(0.5, 1);
	$('#spinner_' + park).hide();	
}

function get_freeSlots(park, rapid) {
	if (ajax_active !== true && rapid !== true) return;
	progress = $('#park_' + park + ' .progress');
	freeslots = $('#freeslots_' + park).text()
	$.ajax({
		'dataType':'json', 
		'url':'/parkbz/default/freeslots/parkID/freeSlots'.replace(/parkID/, park).replace(/freeSlots/, freeslots),
		'beforeSend': function (xhr) {
			$(progress).fadeTo(0, 0.5);
			$('#spinner_' + park).show();
		},
		'success':function(data){
			parseAnswer(park, data);
		},
	}); 
}
</script>
