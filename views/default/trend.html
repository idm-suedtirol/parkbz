{{extend 'layout.html'}}
<section>
<div class='span3'>
<div class='well' style="padding: 7px 0px;">
	<ul id='logs' class="nav nav-list">
		<li class="nav-header">Parks list</li>
		{{for park in parks:}}
			<li><a id='park_{{=park['park_id']}}' title="{{=park['name']}}" href="#" class="muted">
	<!--input  id='park_{{=park['park_id']}}' type="checkbox" {{='checked=checked' if park['park_id'] == int(park_id) else ''}}-->
				{{=park['name']}}
			</a></li>	
		{{pass}}
	</ul>
</div>
</div>
<div class="span9">
<div class='row-fluid'>
	<div id="myTabContent" class="chart">
		<p id='loading' class="label label-info span4 offset4 center">Loading...</p>
		<ul class="nav nav-pills"> 
		<li><a class='last' href="#" id="last_1">Last 24h</a></li>
		<li class="active"><a href="#" class='last' id="last_7">Last 7days</a></li>
		<li><a href="#" class='last' id="last_30">Last 30days</a></li>
		</ul>
		<div id="traffic_chart_h"  style="height:370px"></div>
	</div>
</div>
</div>
<script>    
	var options = { 
		xaxis: { mode: "time", timeZoneOffset: "browser"},
		yaxis: { position: 'left', axisLabel: "{{=T('Free slots')}}", max: 1000, zoomRange: false, panRange: false, },
		series:{ lines: { show: true, fill: true },
		points: { show: false }},
		crosshair: { mode: null },
		pan: { interactive: true },
		zoom: { interactive: true},
		tooltip: true,       
		tooltipOpts: {
			content:      "%s |  %x |  %y",
			xDateFormat: "%b %d, %H:%M:%S",
			defaultTheme:  true,
		},
		grid: {
			color: "#444444",
			backgroundColor: "#DDDDDD",
			borderColor: "#FFFFFF",
			tickColor: "#CCCCCC",
			//aboveData: false,
			borderWidth: 0,
			clickable: true,
			hoverable: true,
			autoHighlight: true,
		},
		touch: {autoHeight: false, autoWidth: false},
	}
	var placeholder_h = $("#traffic_chart_h");
	var datasets = {};	// All data available
	var data = [];		// All data shown
	var interval = 7; 	// Default 7 days

	function onDataReceived (json) {
		for (var k in json) {
			json[k]['label'] = $('#'+k).attr('title') ;
			data.push(json[k]);
		}
		$.extend(datasets, json); 
		plotAccordingToChoices();
	}

	$(document).on('click', '#logs a', function() {
		var key = $(this).attr("id");	
		$(this).toggleClass('muted');

		if (typeof datasets[key] === "undefined") {
			if ( ! $(this).hasClass('muted')) { 
				return get_park_history(key.split('_')[1])
			} else { 
				// skip already coming call			
				$(this).toggleClass('muted');
			}
		} else {
			if ($(this).hasClass('muted')) {
				if (key && datasets[key]) {
					var index = data.indexOf(datasets[key]);
					data.splice(index, 1);
				}
			} else {
				if (key && datasets[key])
					data.push(datasets[key]);
			}
		}
		plotAccordingToChoices();	
	});

	function plotAccordingToChoices() {
		if (data.length>1) {
			options.crosshair.mode = 'x';
		} else {
			options.crosshair.mode = null;
		}
		$.plot($(placeholder_h), data, options);
		$('#loading').hide();
	}

	$(document).on('click', "li a[class='last']", function() {
		$(this).parent().siblings().removeClass('active');
		$(this).parent().addClass('active');
		var next_interval = $(this).attr('id').split('_')[1];
		if (next_interval === interval) return;
		interval = next_interval;
		datasets = {};	//errase different interval data
		keys=[]
		for (key in data) {
/*			console.log(data[key]['park_id']);
			keys.push (data[key]['park_id']);*/
			get_park_history(data[key]['park_id']);
		}
		data = [];
		for (key in keys) {
			console.log(key);
			get_park_history(key);	
		}
	});

	function get_park_history(park_id) {
		$('#loading').show();
		$.ajax({
			url: '{{=URL("default", "get_history.json", args=['park_idJS'], vars={'interval':'intervalJs'} )}}'.replace(/park_idJS/,park_id).replace(/intervalJs/, interval),
			method: 'GET',
		    dataType: 'json',
		    success: onDataReceived
		});
	}
	// Starting call
	$("#park_" + {{=park_id}}).click();
</script>
</section>
