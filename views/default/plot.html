{{extend 'layout.html'}}
<section>
<div class='span3'>
<div class='well' style="padding: 7px 0px;">
	<ul id='logs' class="nav nav-list">
		<li class="nav-header">Parks list</li>
		<!--li><label class="checkbox"><input id='all' type="checkbox" checked='checked'>All</label></li-->	
		{{for park in parks:}}
			<li><label id='label_park_{{=park['park_id']}}' title="{{=park['name']}}" class="checkbox"><input  id='park_{{=park['park_id']}}' type="checkbox"/>{{=park['name']}}</label></li>	
		{{pass}}
	</ul>
</div>
</div>
<p id='loading' class="label label-info span4 offset4 center">Loading...</p>	

<div class="span9">
<div class='row-fluid'>
	<div id="myTabContent" class="chart">
		<ul class="nav nav-pills"> 
		<li ><a >Last 24h</a></li>
		<li class="active"><a >Last 7days</a></li>
		<li><a >Last 30days</a></li>
		</ul>
		<div id="traffic_chart_h"  style="height:500px"> </div>
	</div>
</div>
</div>
<script>    
	var plot;
	var options = { xaxis: { mode: "time", timeZoneOffset: "browser" },
			yaxis: { zoomRange: [0, null], panRange: [0, null]},
			//crosshair: { mode: "x" },
			y2axis: {mode: null},
			series:{ lines: { show: true, fill: true },
				points: { show: false }},
pan: { interactive: true },
/*xaxis, yaxis, x2axis, y2axis: {
	zoomRange: null,  // or [ number, number ] (min range, max range) or false
	panRange: null  // or [ number, number ] (min, max) or false
},*/
zoom: { interactive: true},
tooltip: true,       //false
tooltipOpts: {
	content:      "%s |  %x |  %y",
	//xDateFormat: "%H:%M:%S",
	yDateFormat: "%H:%M:%S",
	defaultTheme:  true     //true
},
	grid: {	//show: true,
				color: "#444444",
				backgroundColor: "#DDDDDD",
				borderColor: "#FFFFFF",
				tickColor: "#CCCCCC",
				//aboveData: false,
				borderWidth: 0,
				clickable: true,
				hoverable: true,
				autoHighlight: true,}

}
	var placeholder_h = $("#traffic_chart_h");

	var datasets, plot, data, range_from, range_to;	
	datasets = {}
	function onDataReceived (json) {
		$('#loading').hide();
		data = [];
		for (var k in json)
			console.log($(k).title);
			console.log($('#'+k).parent().attr('title'))	; 
			json[k]['label']='d' ;
		$.extend(datasets, json); 
		plotAccordingToChoices();
	}



	function onDataReceived_single(json) {
		//console.log(json);
		//for (var attrname in json) { datasets[attrname] = json[attrname]; }
		for (var i in json) {
			datasets[i] = json[i]
			if ($('#' + json[i].id))
				$('#' + json[i].id).parent().remove();
			var str = "<label class='checkbox'><input id='idJS' type='checkbox' checked='checkek'>labelJS</label>".replace(/labelJS/, json[i].label ).replace(/idJS/, json[i].id );
			console.log(	json[i].id );		
			splits = json[i].id.split('_')
			$('#'+splits[0]).append(str).hide().slideDown();
		}
		plotAccordingToChoices();
	}

	function onDataReceived_m (json) {
		$.plot(placeholder_m, [json.data], { xaxis: { mode: "time", timeZoneOffset: "browser" }});
	}

	$(document).on('click', 'input', function() {
		var key = $(this).attr("id");	
		console.log(key, datasets[key]);	
		if (key === 'all') {
			that = $(this)
			$(document).find("input:checked").each(function () {
				if ($(this) !== $(that)) {
					$(this).removeAttr('checked');				
				}
			});
			data = [];
		} else if (typeof datasets[key] === "undefined") {
			return get_park_history(key.split('_')[1])
		} else {
			if ($("#all").attr('checked') === 'checked'){
				data = []						
			}
			$("#all").removeAttr('checked');
			if ($(this).attr('checked') === 'checked'){
				if (key && datasets[key])
					data.push(datasets[key]);
			} else {
				if (key && datasets[key])
					var index = data.indexOf(datasets[key]);
					data.splice(index, 1);
			}
		}
		plotAccordingToChoices();	
	});


    
	function plotAccordingToChoices() {
		if ( data.length == 0 ) {
			for (var i in datasets) {
				data.push(datasets[i]);
			}
			$("#all").attr('checked', 'checked');
		} 
		$.plot($(placeholder_h), data, options);
	}

   $("#clearSelection").click(function () {
        $.plot.clearSelection(true);
    });
	function get_park_history(park_id) {
		$('#loading').show();
		$.ajax({
		    url: '{{=URL("default", "get_history.json", args=['park_idJS'] )}}'.replace(/park_idJS/,park_id),
		    method: 'GET',
		    dataType: 'json',
		    success: onDataReceived
		});
	}
	get_park_history({{=park_id}});
</script>
</section>
